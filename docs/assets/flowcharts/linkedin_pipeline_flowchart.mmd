flowchart TB
    A[Config + Mode Selection<br/>Snakemake + YAML] --> B[Preflight Validation<br/>Resources / Inputs / Build checks]
    B --> C{Mode}

    %% FULL MODE
    C -->|Full Mode| F1[FASTQ Inputs<br/>samplesheet + metadata]
    F1 --> F2[QC + Trimming<br/>FastQC / fastp / MultiQC]
    F2 --> F3[Alignment<br/>BWA-MEM2 / BWA / minimap2 / STAR]
    F3 --> F4[BAM Processing<br/>sort / index / markdup / alignment QC]
    F4 --> F5[Variant Calling + Filtering<br/>bcftools mpileup/call/filter]
    F5 --> VFINAL[Final Filtered VCF]

    %% VARIANT ONLY
    C -->|Variant-Only Mode| V1[External Variant Input<br/>VCF / VCF.GZ / CSV / TSV]
    V1 --> V2{Input Type}
    V2 -->|VCF| V3[Normalize + Filter<br/>bcftools + tabix]
    V2 -->|CSV / TSV| V4[Convert + Normalize<br/>csv_to_vcf.py]
    V4 --> V5[Alias Mapping + REF Derivation<br/>Diagnostics Report]
    V5 --> V3
    V3 --> VFINAL

    %% SHARED INTERPRETATION
    VFINAL --> I1[Variant Annotation Layer<br/>overlap or snpEff]
    I1 --> I2[Variant-to-Gene Mapping<br/>VCF->BED + bedtools intersect]
    I2 --> I3[Interpretation Outputs]
    I3 --> I31[Variant QC Metrics + Plots]
    I3 --> I32[GWAS-style Visuals<br/>Manhattan / QQ / Volcano / Heatmap]
    I3 --> I33[Gene/Pathway Enrichment]

    %% PRS
    VFINAL --> P1{PRS Weights Configured?}
    P1 -->|Yes| P2[PRS Scoring + Harmonization<br/>prs_from_vcf.py]
    P2 --> P3[PRS QC + Scores + Plot]
    P1 -->|No| P4[Skip PRS Branch]

    %% RNA branch
    F3 --> R1{RNA mode?}
    R1 -->|Yes| R2[RNA Quant + DGE + Enrichment<br/>StringTie / featureCounts / DESeq2]
    R1 -->|No| R3[Skip RNA Branch]

    %% AI (optional)
    I31 --> AI0{AI Enabled?}
    I32 --> AI0
    I33 --> AI0
    P3 --> AI0
    R2 --> AI0
    B --> AI0

    AI0 -->|Yes| AI1[AI QC Anomaly Report]
    AI0 -->|Yes| AI2[AI Variant Prioritization]
    AI0 -->|Yes| AI3[AI Explainer Summary]
    AI1 --> AI3
    AI2 --> AI3

    %% Final
    AI0 -->|No| Z[Run Manifest + Final Outputs]
    AI1 --> Z
    AI2 --> Z
    AI3 --> Z
    Z --> END([End])
